<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®Ø·Ø¨Ù‡â€Œ Ù†Ù…Ø§Ø² Ø¬Ù…Ø¹Ù‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªÙˆÙ„ÛŒØ¯ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø¨Ù‡ Ù†Ú¯Ø§Ø´Øª */
        @font-face {
            font-family: 'B Nazanin';
            src: url('https://cdn.fontcdn.ir/Font/Persian/BNazanin/BNazanin.woff2') format('woff2');
            font-weight: normal;
        }
        @font-face {
            font-family: 'B Titr';
            src: url('https://cdn.fontcdn.ir/Font/Persian/BTitr/BTitrBold.woff2') format('woff2');
            font-weight: bold;
        }

        :root {
            --primary: #0ea5e9;
            --secondary: #8b5cf6;
            --dark-glass: rgba(15, 23, 42, 0.7);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            overflow-x: hidden;
            background-color: #020617;
            color: #e2e8f0;
        }

        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -2; pointer-events: none;
        }

        #ai-core {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90vw; max-width: 400px; height: 90vw; max-height: 400px; 
            z-index: -1; pointer-events: none; opacity: 0.15;
            transition: transform 0.1s ease-out; filter: drop-shadow(0 0 30px var(--primary));
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float { 0% { top: 50%; } 50% { top: 48%; } 100% { top: 50%; } }

        .glass-panel {
            background: var(--dark-glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        .glass-panel::before {
            content: ""; position: absolute; top: var(--mouse-y, 0); left: var(--mouse-x, 0);
            transform: translate(-50%, -50%); 
            width: 100vw; height: 100vw; max-width: 500px; max-height: 500px;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.1) 0%, transparent 70%);
            pointer-events: none; z-index: 0; transition: opacity 0.3s;
        }
        .glass-panel > * { position: relative; z-index: 1; }

        .neon-input {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: #f8fafc; transition: all 0.4s;
        }
        .neon-input:focus {
            background: rgba(0, 0, 0, 0.5); border-color: var(--primary);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2), inset 0 0 10px rgba(14, 165, 233, 0.1); transform: translateY(-2px);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); box-shadow: 0 0 10px var(--primary); }

        .cyber-btn {
            position: relative; background: linear-gradient(135deg, var(--primary), var(--secondary));
            overflow: hidden; z-index: 1; transition: all 0.3s ease;
            touch-action: manipulation;
        }
        .cyber-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s ease; z-index: -1;
        }
        .cyber-btn:hover::before { left: 100%; }
        .cyber-btn:hover { box-shadow: 0 0 25px rgba(139, 92, 246, 0.5); transform: scale(1.02); }

        .radar-loader {
            width: 80px; height: 80px; border-radius: 50%; border: 2px solid rgba(14, 165, 233, 0.2);
            position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); margin: 0 auto;
        }
        .radar-loader::before {
            content: ""; position: absolute; top: 50%; left: 50%; width: 50%; height: 50%;
            background: linear-gradient(45deg, transparent, rgba(14, 165, 233, 0.8));
            transform-origin: 0 0; animation: radar 2s linear infinite;
        }
        @keyframes radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .output-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; position: relative; overflow: hidden;
            word-wrap: break-word;
        }
        .output-card::before { content: ""; position: absolute; top: 0; right: 0; width: 4px; height: 100%; }
        .output-khutbah1::before { background: #3b82f6; }
        .output-khutbah2::before { background: #10b981; }
        .output-overall::before { background: #f59e0b; }

        .cursor-blink::after { content: '|'; animation: blink 1s step-end infinite; color: var(--primary); }
        @keyframes blink { 50% { opacity: 0; } }

        @media (max-width: 768px) {
            #particle-canvas { display: none !important; }
            #ai-core { display: none !important; }
            .glass-panel::before { display: none !important; }
        }
    </style>
</head>
<body class="antialiased text-gray-200">

<!-- Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ PDF Ø®Ù†Ø«ÛŒ (Ø¨Ø¯ÙˆÙ† oklab/oklch) -->
<div id="pdfPrintArea" style="display:none; position:absolute; left:-9999px; width:800px; padding:40px; background:#ffffff; color:#000000; font-family:tahoma, arial, sans-serif; direction:rtl; text-align:right;"></div>

<canvas id="particle-canvas"></canvas>

<svg id="ai-core" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="45" fill="none" stroke="#0ea5e9" stroke-width="0.5" stroke-dasharray="2 4" />
    <circle cx="50" cy="50" r="35" fill="none" stroke="#8b5cf6" stroke-width="1" stroke-dasharray="10 5">
        <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="20s" repeatCount="indefinite"/>
    </circle>
    <circle cx="50" cy="50" r="20" fill="none" stroke="#0ea5e9" stroke-width="2" />
    <circle id="pupil" cx="50" cy="50" r="8" fill="#0ea5e9" opacity="0.8">
        <animate attributeName="r" values="8;10;8" dur="3s" repeatCount="indefinite" />
    </circle>
</svg>

<div class="container mx-auto max-w-6xl p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">

    <header class="text-center mb-10 relative z-10 w-full mt-8">
        <div class="inline-block border border-sky-500/30 bg-sky-500/10 text-sky-400 px-4 py-1 rounded-full text-xs md:text-sm font-bold tracking-widest mb-4 shadow-[0_0_10px_rgba(14,165,233,0.2)]">
            AI SERMON ANALYZER
        </div>
        <h1 class="text-3xl md:text-5xl lg:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-purple-500 drop-shadow-lg mb-4">
            Ø®Ù„Ø§ØµÙ‡ Ø³Ø§Ø²ÛŒ Ø®Ø·Ø¨Ù‡ Ù‡Ø§
        </h1>
        <p class="text-gray-400 text-base md:text-xl font-light">Ù†Ø³Ø®Ù‡ Ø§Ù…Ù† Ùˆ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª IP</p>
    </header>

    <main id="mainCard" class="glass-panel w-full p-5 md:p-10 rounded-3xl transition-all duration-500 relative">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-10">
            <div class="group relative">
                <label class="block mb-3 font-bold text-sky-300 text-base md:text-lg">
                    Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„ (Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø°Ù‡Ø¨ÛŒ)
                </label>
                <textarea id="khutbah1" class="neon-input w-full p-4 md:p-5 rounded-2xl outline-none text-gray-200 leading-relaxed resize-none text-base h-40 md:h-60" placeholder="Ù…ØªÙ† Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>
            <div class="group relative">
                <label class="block mb-3 font-bold text-purple-300 text-base md:text-lg">
                    Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ… (Ù…Ø­ØªÙˆØ§ÛŒ Ø³ÛŒØ§Ø³ÛŒ/Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ)
                </label>
                <textarea id="khutbah2" class="neon-input w-full p-4 md:p-5 rounded-2xl outline-none text-gray-200 leading-relaxed resize-none text-base h-40 md:h-60" placeholder="Ù…ØªÙ† Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ… Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
            </div>
        </div>

        <div class="text-center mb-6 relative z-10 flex justify-center">
            <button id="generateBtn" class="cyber-btn flex items-center justify-center text-white font-black text-lg md:text-xl py-4 px-8 md:px-12 rounded-full cursor-pointer shadow-lg w-full md:w-auto">
                <svg class="w-6 h-6 md:w-7 md:h-7 ml-3 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Ø¢ØºØ§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
            </button>
        </div>
        
        <div id="loading" class="hidden flex flex-col items-center justify-center my-10 transition-all duration-500 opacity-0 w-full">
            <div class="radar-loader"></div>
            <p id="loadingText" class="mt-6 text-sky-400 font-bold text-base md:text-lg tracking-widest text-center">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± ÙˆØ§Ø³Ø·Ù‡...</p>
        </div>

        <div id="resultContainer" class="hidden mt-8 transform transition-all duration-700 opacity-0 translate-y-10">
            <div class="flex flex-col lg:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-700/50 gap-4">
                <h2 class="text-2xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600 flex items-center w-full lg:w-auto text-center lg:text-right justify-center lg:justify-start">
                    Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯
                </h2>
                
                <div class="flex flex-wrap gap-2 w-full lg:w-auto justify-center">
                    <button id="copyBtn" class="group flex items-center justify-center bg-gray-800 hover:bg-emerald-600 border border-gray-600 text-gray-300 hover:text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 text-sm">
                        <span id="copyText">Ú©Ù¾ÛŒ Ù…ØªÙ†</span>
                    </button>

                    <button id="wordBtn" class="group flex items-center justify-center bg-blue-900/50 hover:bg-blue-600 border border-blue-700/50 text-blue-200 hover:text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 text-sm">
                        Word Ø®Ø±ÙˆØ¬ÛŒ
                    </button>

                    <button id="pdfBtn" class="group flex items-center justify-center bg-red-900/50 hover:bg-red-600 border border-red-700/50 text-red-200 hover:text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 text-sm">
                        PDF Ø®Ø±ÙˆØ¬ÛŒ
                    </button>

                    <button id="graphicBtn" class="w-full sm:w-auto group flex items-center justify-center bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 border border-pink-500 text-white font-bold py-2 px-4 rounded-xl transition-all duration-300 text-sm shadow-[0_0_15px_rgba(236,72,153,0.4)]">
                        Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø·Ø¨Ù‡â€ŒÙ†Ú¯Ø§Ø´Øª (ØªØµÙˆÛŒØ±)
                    </button>
                </div>
            </div>
            
            <div id="output" class="text-base md:text-lg leading-loose text-gray-300 font-medium"></div>

            <!-- Ø¨Ø®Ø´ ØªØµØ§ÙˆÛŒØ± Ø®Ø·Ø¨Ù‡ Ù†Ú¯Ø§Ø´Øª -->
            <div id="graphicsContainer" class="hidden mt-10 pt-8 border-t border-gray-700/50">
                <h3 class="text-2xl font-bold text-center text-pink-400 mb-6">ØªØµØ§ÙˆÛŒØ± Ø®Ø·Ø¨Ù‡â€ŒÙ†Ú¯Ø§Ø´Øª</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- ØªØµÙˆÛŒØ± Ø§ÙˆÙ„ -->
                    <div class="flex flex-col items-center bg-gray-900/50 p-4 rounded-2xl border border-gray-700">
                        <span class="text-sky-400 font-bold mb-3">Ø®Ø·Ø¨Ù‡â€ŒÙ†Ú¯Ø§Ø´Øª Ù…Ø°Ù‡Ø¨ÛŒ (Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„)</span>
                        <div id="canvasLoader1" class="text-gray-400 text-sm animate-pulse mb-2 hidden">Ø¯Ø± Ø­Ø§Ù„ Ø±Ù†Ø¯Ø± ØªØµÙˆÛŒØ±...</div>
                        <img id="imgKhutbah1" class="w-full rounded-lg shadow-lg hidden" alt="Ø®Ø·Ø¨Ù‡ Ù†Ú¯Ø§Ø´Øª Ø§ÙˆÙ„" />
                        <button id="dlImg1" class="hidden mt-4 w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 rounded-xl transition-colors">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ÛŒÙ† ØªØµÙˆÛŒØ±</button>
                    </div>
                    <!-- ØªØµÙˆÛŒØ± Ø¯ÙˆÙ… -->
                    <div class="flex flex-col items-center bg-gray-900/50 p-4 rounded-2xl border border-gray-700">
                        <span class="text-emerald-400 font-bold mb-3">Ø®Ø·Ø¨Ù‡â€ŒÙ†Ú¯Ø§Ø´Øª Ø³ÛŒØ§Ø³ÛŒ (Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ…)</span>
                        <div id="canvasLoader2" class="text-gray-400 text-sm animate-pulse mb-2 hidden">Ø¯Ø± Ø­Ø§Ù„ Ø±Ù†Ø¯Ø± ØªØµÙˆÛŒØ±...</div>
                        <img id="imgKhutbah2" class="w-full rounded-lg shadow-lg hidden" alt="Ø®Ø·Ø¨Ù‡ Ù†Ú¯Ø§Ø´Øª Ø¯ÙˆÙ…" />
                        <button id="dlImg2" class="hidden mt-4 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 rounded-xl transition-colors">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ÛŒÙ† ØªØµÙˆÛŒØ±</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="error" class="hidden mt-6 bg-red-900/30 border border-red-500/50 text-red-400 p-5 rounded-xl backdrop-blur-sm" role="alert">
            <strong class="font-bold text-lg">Ø®Ø·Ø§!</strong>
            <span class="block mt-2 font-medium text-red-200" id="errorMessage"></span>
        </div>
    </main>
</div>

<textarea id="copyHelper" class="hidden absolute -left-full -top-full"></textarea>

<script>
    // --- Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
    const isMobileDevice = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (!isMobileDevice) {
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let width, height, particles;
        let mouse = { x: null, y: null, radius: 150 };

        function initCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            particles =[];
            let particleCount = (width * height) / 12000;
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * width, y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
                    radius: Math.random() * 2 + 1
                });
            }
        }

        function drawParticles() {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = 'rgba(14, 165, 233, 0.5)';
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0 || p.x > width) p.vx *= -1;
                if (p.y < 0 || p.y > height) p.vy *= -1;
                if(mouse.x != null) {
                    let dx = mouse.x - p.x; let dy = mouse.y - p.y;
                    if (Math.sqrt(dx * dx + dy * dy) < mouse.radius) { p.x += dx * 0.01; p.y += dy * 0.01; }
                }
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); ctx.fill();
            });
            requestAnimationFrame(drawParticles);
        }
        window.addEventListener('resize', initCanvas); initCanvas(); drawParticles();

        const mainCard = document.getElementById('mainCard');
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX; mouse.y = e.clientY;
            const rect = mainCard.getBoundingClientRect();
            mainCard.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
            mainCard.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
        });
        window.addEventListener('mouseout', () => { mouse.x = null; mouse.y = null; });
    }

    // --- Ù…ØªØºÛŒØ±Ù‡Ø§ Ùˆ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ ---
    const generateBtn = document.getElementById('generateBtn');
    const khutbah1Input = document.getElementById('khutbah1');
    const khutbah2Input = document.getElementById('khutbah2');
    const loadingDiv = document.getElementById('loading');
    const resultContainer = document.getElementById('resultContainer');
    const outputDiv = document.getElementById('output');
    
    let currentReportData = null;
    const introText = "Ø¨Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¹Ø§ÙˆÙ†Øª Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª Ùˆ Ø±Ø³Ø§Ù†Ù‡ Ø¯ÙØªØ± Ø§Ù…Ø§Ù… Ø¬Ù…Ø¹Ù‡ Ø¯Ù‡Ø³ØªØ§Ù† Ù…ÛŒØ§Ù†Ú©Ø§Ù„Ù‡ (Ø²Ø§ØºÙ…Ø±Ø²)ØŒ Ø­Ø¬Øª Ø§Ù„Ø§Ø³Ù„Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ù„Ù…ÛŒÙ† Ø­Ø§Ø¬ Ø­Ø³ÛŒÙ† Ø§Ù†Ø²Ø§Ø¦ÛŒ Ø¯Ø± Ø®Ø·Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù‡ÙØªÙ‡ Ø§Ø² Ù†Ù…Ø§Ø² Ø¬Ù…Ø¹Ù‡ØŒ Ø¶Ù…Ù† Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ ØªÙ‚ÙˆØ§ Ø§Ø¸Ù‡Ø§Ø± Ú©Ø±Ø¯:";

    function toPersianDigits(str) {
        if(!str) return "";
        const persianDigits =['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
        return str.toString().replace(/\d/g, x => persianDigits[x]);
    }

    function getPersianDateStr() {
        return new Date().toLocaleDateString('fa-IR', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    // --- Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ---
    generateBtn.addEventListener('click', handleGeneration);
    document.getElementById('copyBtn').addEventListener('click', copyOutput);
    document.getElementById('wordBtn').addEventListener('click', exportToWord);
    document.getElementById('pdfBtn').addEventListener('click', exportToPDF);
    document.getElementById('graphicBtn').addEventListener('click', generateGraphics);

    async function handleGeneration() {
        const kh1 = khutbah1Input.value.trim();
        const kh2 = khutbah2Input.value.trim();
        if (!kh1 || !kh2) return document.getElementById('errorMessage').innerText = "Ù‡Ø± Ø¯Ùˆ Ø®Ø·Ø¨Ù‡ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯", document.getElementById('error').classList.remove('hidden');

        document.getElementById('error').classList.add('hidden');
        resultContainer.classList.add('hidden');
        document.getElementById('graphicsContainer').classList.add('hidden');
        
        generateBtn.disabled = true; loadingDiv.classList.remove('hidden');

        // Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø®Ø´ Ø·Ù„Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø¨Ù‡ Ù†Ú¯Ø§Ø´Øª
        const prompt = `
            Ø´Ù…Ø§ Ø¯Ø³ØªÛŒØ§Ø± ØªØ­Ù„ÛŒÙ„ Ø®Ø·Ø¨Ù‡ Ù‡Ø³ØªÛŒØ¯. Ù…ØªÙ† Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„: ${kh1} \n Ù…ØªÙ† Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ…: ${kh2}
            1. impactfulTitle: ØªÛŒØªØ± Ú©Ù„ÛŒ Ø¬Ø°Ø§Ø¨
            2. khutbah1.title: ØªÛŒØªØ± Ø®Ø·Ø¨Ù‡ 1
            3. khutbah1.summary: Ø®Ù„Ø§ØµÙ‡ Ø®Ø·Ø¨Ù‡ 1 (Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø² heading Ùˆ explanation)
            4. khutbah1.bestQuote: ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ø¨Ø³ÛŒØ§Ø± Ø²ÛŒØ¨Ø§ØŒ ØªØ§Ø«ÛŒØ±Ú¯Ø°Ø§Ø± Ùˆ Ø·Ù„Ø§ÛŒÛŒ Ø§Ø² Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³â€ŒÙ†ÙˆØ´ØªÙ‡ (Ø­Ø¯ÙˆØ¯ Û²Û° ØªØ§ Û³Ûµ Ú©Ù„Ù…Ù‡).
            5. khutbah2.title: ØªÛŒØªØ± Ø®Ø·Ø¨Ù‡ 2
            6. khutbah2.summary: Ø®Ù„Ø§ØµÙ‡ Ø®Ø·Ø¨Ù‡ 2 (Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø² heading Ùˆ explanation)
            7. khutbah2.bestQuote: ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ø¨Ø³ÛŒØ§Ø± Ø²ÛŒØ¨Ø§ØŒ Ú©ÙˆØ¨Ù†Ø¯Ù‡ Ùˆ Ø·Ù„Ø§ÛŒÛŒ Ø§Ø² Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ… Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³â€ŒÙ†ÙˆØ´ØªÙ‡ Ø³ÛŒØ§Ø³ÛŒ (Ø­Ø¯ÙˆØ¯ Û²Û° ØªØ§ Û³Ûµ Ú©Ù„Ù…Ù‡).
            8. overallSummary.title: ØªÛŒØªØ± Ø®Ù„Ø§ØµÙ‡ Ù†Ù‡Ø§ÛŒÛŒ
            9. overallSummary.text: Ø®Ù„Ø§ØµÙ‡ Ú©Ù„ÛŒ
            ÙÙ‚Ø· JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†.
        `;

        const schema = {
            type: "OBJECT", properties: {
                impactfulTitle: { type: "STRING" },
                khutbah1: { type: "OBJECT", properties: { title: { type: "STRING" }, summary: { type: "ARRAY", items: { type: "OBJECT", properties: { heading: { type: "STRING" }, explanation: { type: "STRING" } } } }, bestQuote: { type: "STRING" } } },
                khutbah2: { type: "OBJECT", properties: { title: { type: "STRING" }, summary: { type: "ARRAY", items: { type: "OBJECT", properties: { heading: { type: "STRING" }, explanation: { type: "STRING" } } } }, bestQuote: { type: "STRING" } } },
                overallSummary: { type: "OBJECT", properties: { title: { type: "STRING" }, text: { type: "STRING" } } }
            }
        };

        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
            const response = await fetch('/api/proxy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            
            if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
            const result = await response.json();
            const data = JSON.parse(result.candidates[0].content.parts[0].text);
            
            currentReportData = data;
            buildOutputDOM(data);
        } catch (err) {
            document.getElementById('errorMessage').innerText = err.message;
            document.getElementById('error').classList.remove('hidden');
        } finally {
            loadingDiv.classList.add('hidden'); generateBtn.disabled = false;
        }
    }

    function buildOutputDOM(data) {
        let rawText = `Â«${data.impactfulTitle}Â»\n\n${introText}\n\nğŸ”¸ Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„: ${data.khutbah1.title}\n`;
        data.khutbah1.summary.forEach((i, idx) => rawText += `${idx + 1}. ${i.heading}\n   ${i.explanation}\n\n`);
        rawText += `---\nğŸ”¹ Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ…: ${data.khutbah2.title}\n`;
        data.khutbah2.summary.forEach((i, idx) => rawText += `${idx + 1}. ${i.heading}\n   ${i.explanation}\n\n`);
        rawText += `---\nğŸ“Œ ${data.overallSummary.title}\n${data.overallSummary.text}`;
        document.getElementById('copyHelper').value = toPersianDigits(rawText);

        outputDiv.innerHTML = `
            <div class="text-center mb-8">
                <h3 class="text-2xl md:text-3xl font-black text-sky-300 mb-4">Â«${toPersianDigits(data.impactfulTitle)}Â»</h3>
                <p class="text-gray-300 text-lg mx-auto border-b border-gray-700/50 pb-6">${toPersianDigits(introText)}</p>
            </div>
            <div class="output-card output-khutbah1">
                <h4 class="text-xl font-bold text-blue-400 mb-4">Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„: ${toPersianDigits(data.khutbah1.title)}</h4>
                <div class="space-y-4 pr-2">
                    ${data.khutbah1.summary.map((i, idx) => `<div class="border-r-2 border-blue-500/30 pr-4"><strong class="text-blue-300 block mb-1">${toPersianDigits(idx + 1)}. ${toPersianDigits(i.heading)}</strong><span class="text-gray-400">${toPersianDigits(i.explanation)}</span></div>`).join('')}
                </div>
            </div>
            <div class="output-card output-khutbah2">
                <h4 class="text-xl font-bold text-emerald-400 mb-4">Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ…: ${toPersianDigits(data.khutbah2.title)}</h4>
                <div class="space-y-4 pr-2">
                    ${data.khutbah2.summary.map((i, idx) => `<div class="border-r-2 border-emerald-500/30 pr-4"><strong class="text-emerald-300 block mb-1">${toPersianDigits(idx + 1)}. ${toPersianDigits(i.heading)}</strong><span class="text-gray-400">${toPersianDigits(i.explanation)}</span></div>`).join('')}
                </div>
            </div>
            <div class="output-card output-overall">
                <h4 class="text-xl font-bold text-amber-400 mb-4">${toPersianDigits(data.overallSummary.title)}</h4>
                <p class="text-gray-300 pr-2">${toPersianDigits(data.overallSummary.text)}</p>
            </div>
        `;
        resultContainer.classList.remove('hidden');
        setTimeout(() => { resultContainer.classList.remove('opacity-0', 'translate-y-10'); }, 100);
    }

    // --- ØªÙˆØ§Ø¨Ø¹ Ø®Ø±ÙˆØ¬ÛŒ ---
    async function copyOutput() {
        await navigator.clipboard.writeText(document.getElementById('copyHelper').value);
        document.getElementById('copyText').innerText = 'Ú©Ù¾ÛŒ Ø´Ø¯!';
        setTimeout(() => document.getElementById('copyText').innerText = 'Ú©Ù¾ÛŒ Ù…ØªÙ†', 2000);
    }

    function exportToWord() {
        if (!currentReportData) return;
        let wordHTML = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>Ú¯Ø²Ø§Ø±Ø´</title><style>body{font-family:'B Nazanin',Arial;font-size:14pt;direction:rtl;text-align:right;} p{margin:0 0 10pt 0;line-height:1.5;}</style></head><body>`;
        wordHTML += `<p style="text-align:center;font-weight:bold;font-size:16pt">Â«${currentReportData.impactfulTitle}Â»</p><p>${introText}</p>`;
        wordHTML += `<p style="font-weight:bold;margin-top:15pt">ğŸ”¸ Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„: ${currentReportData.khutbah1.title}</p>`;
        currentReportData.khutbah1.summary.forEach((item, index) => wordHTML += `<p>${index + 1}. <b>${item.heading}</b><br>${item.explanation}</p>`);
        wordHTML += `<p style="font-weight:bold;margin-top:15pt">ğŸ”¹ Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ…: ${currentReportData.khutbah2.title}</p>`;
        currentReportData.khutbah2.summary.forEach((item, index) => wordHTML += `<p>${index + 1}. <b>${item.heading}</b><br>${item.explanation}</p>`);
        wordHTML += `<p style="font-weight:bold;margin-top:15pt">ğŸ“Œ ${currentReportData.overallSummary.title}</p><p>${currentReportData.overallSummary.text}</p></body></html>`;
        
        const blob = new Blob(['\ufeff', toPersianDigits(wordHTML)], { type: 'application/msword' });
        const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'Ú¯Ø²Ø§Ø±Ø´_Ø®Ø·Ø¨Ù‡.doc'; link.click();
    }

    // --- Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ØªÙ‡Ø§Ø¬Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø¨Ø§Ú¯ PDF ØªÛŒÙ„â€ŒÙˆÙ†Ø¯ Ù†Ø³Ø®Ù‡ 4 ---
    async function exportToPDF() {
        if (!currentReportData) return;
        const pdfBtn = document.getElementById('pdfBtn');
        pdfBtn.innerText = "Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª PDF...";
        
        // Ø³Ø§Ø®Øª ÛŒÚ© DOM Ú©Ø§Ù…Ù„Ø§ ØªÙ…ÛŒØ² Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ù†ØªÛŒ RGB (Ø¨Ø¯ÙˆÙ† oklch) Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ± Ø²Ø¯Ù† Ø¨Ø§Ú¯ html2canvas
        const printArea = document.getElementById('pdfPrintArea');
        let rawHTML = `
            <div style="font-family: Tahoma, Arial, sans-serif; direction: rtl; text-align: right; color: #111; line-height: 1.8; padding: 20px;">
                <h1 style="text-align: center; color: #0284c7; font-size: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px;">
                    Â«${toPersianDigits(currentReportData.impactfulTitle)}Â»
                </h1>
                <p style="font-size: 16px; margin-bottom: 20px; text-align: justify;">${toPersianDigits(introText)}</p>
                
                <h2 style="color: #2563eb; font-size: 20px; margin-top: 30px;">ğŸ”¸ Ø®Ø·Ø¨Ù‡ Ø§ÙˆÙ„: ${toPersianDigits(currentReportData.khutbah1.title)}</h2>
                <div style="margin-right: 15px; border-right: 3px solid #bfdbfe; padding-right: 15px;">
                    ${currentReportData.khutbah1.summary.map((i, idx) => `<p style="margin-bottom: 15px;"><b>${toPersianDigits(idx + 1)}. ${toPersianDigits(i.heading)}</b><br><span style="color: #333;">${toPersianDigits(i.explanation)}</span></p>`).join('')}
                </div>

                <h2 style="color: #059669; font-size: 20px; margin-top: 30px;">ğŸ”¹ Ø®Ø·Ø¨Ù‡ Ø¯ÙˆÙ…: ${toPersianDigits(currentReportData.khutbah2.title)}</h2>
                <div style="margin-right: 15px; border-right: 3px solid #a7f3d0; padding-right: 15px;">
                    ${currentReportData.khutbah2.summary.map((i, idx) => `<p style="margin-bottom: 15px;"><b>${toPersianDigits(idx + 1)}. ${toPersianDigits(i.heading)}</b><br><span style="color: #333;">${toPersianDigits(i.explanation)}</span></p>`).join('')}
                </div>

                <h2 style="color: #d97706; font-size: 20px; margin-top: 30px;">ğŸ“Œ ${toPersianDigits(currentReportData.overallSummary.title)}</h2>
                <p style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 1px solid #fde68a;">${toPersianDigits(currentReportData.overallSummary.text)}</p>
            </div>
        `;
        
        printArea.innerHTML = rawHTML;
        printArea.style.display = 'block';

        const opt = {
            margin:       [10, 10, 10, 10],
            filename:     'Ø®Ù„Ø§ØµÙ‡_Ø®Ø·Ø¨Ù‡_Ù†Ù…Ø§Ø²_Ø¬Ù…Ø¹Ù‡.pdf',
            image:        { type: 'jpeg', quality: 1 },
            html2canvas:  { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            await html2pdf().set(opt).from(printArea).save();
        } catch (e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ PDF: " + e.message);
        } finally {
            printArea.style.display = 'none';
            pdfBtn.innerText = "PDF Ø®Ø±ÙˆØ¬ÛŒ";
        }
    }

    // --- Ù…ÙˆØªÙˆØ± ØªÙˆÙ„ÛŒØ¯ Ø®Ø·Ø¨Ù‡ Ù†Ú¯Ø§Ø´Øª Ø±ÙˆÛŒ Canvas ---
    async function generateGraphics() {
        if (!currentReportData) return;
        
        document.getElementById('graphicsContainer').classList.remove('hidden');
        document.getElementById('canvasLoader1').classList.remove('hidden');
        document.getElementById('canvasLoader2').classList.remove('hidden');
        
        const q1 = toPersianDigits(currentReportData.khutbah1.bestQuote);
        const q2 = toPersianDigits(currentReportData.khutbah2.bestQuote);

        try {
            const dataUrl1 = await renderCanvasQuote(q1);
            document.getElementById('imgKhutbah1').src = dataUrl1;
            document.getElementById('imgKhutbah1').classList.remove('hidden');
            document.getElementById('canvasLoader1').classList.add('hidden');
            
            const btn1 = document.getElementById('dlImg1');
            btn1.classList.remove('hidden');
            btn1.onclick = () => downloadImage(dataUrl1, 'Ø®Ø·Ø¨Ù‡_Ù†Ú¯Ø§Ø´Øª_Ù…Ø°Ù‡Ø¨ÛŒ.jpg');

            const dataUrl2 = await renderCanvasQuote(q2);
            document.getElementById('imgKhutbah2').src = dataUrl2;
            document.getElementById('imgKhutbah2').classList.remove('hidden');
            document.getElementById('canvasLoader2').classList.add('hidden');
            
            const btn2 = document.getElementById('dlImg2');
            btn2.classList.remove('hidden');
            btn2.onclick = () => downloadImage(dataUrl2, 'Ø®Ø·Ø¨Ù‡_Ù†Ú¯Ø§Ø´Øª_Ø³ÛŒØ§Ø³ÛŒ.jpg');

            // Scroll down
            document.getElementById('graphicsContainer').scrollIntoView({ behavior: 'smooth' });
        } catch (e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø±Ù†Ø¯Ø± ØªØµÙˆÛŒØ±: " + e.message);
        }
    }

    // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ÛŒÙ…Ù† ØªØµÙˆÛŒØ± Canvas
    function downloadImage(dataUrl, filename) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Ø±Ø³Ù… Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø±ÙˆÛŒ Canvas
    async function renderCanvasQuote(quoteText) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "Anonymous"; 
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² raw URL Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ CORS
        img.src = "https://raw.githubusercontent.com/amirhossein-gandomkar/AISERMONANALYZER/a3bbbbbe683533ce44b9f00bbc618e66eabbc9f9/kh.png";

        await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = () => reject(new Error("ØªØµÙˆÛŒØ± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø§Ø² Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ù„ÙˆØ¯ Ù†Ø´Ø¯."));
        });

        // ØªÙ†Ø¸ÛŒÙ… Ø§Ø¨Ø¹Ø§Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØµÙˆÛŒØ± Ø³ÙˆØ±Ø³
        canvas.width = img.width; 
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const centerX = canvas.width / 2;
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Y Ú©Ø§Ø¯Ø± Ø¢Ø¨ÛŒ Ù¾Ø§ÛŒÛŒÙ† - ØªØ®Ù…ÛŒÙ†ÛŒ Ø¨Ø±Ø§ÛŒ ØªØµÙˆÛŒØ± Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…
        // ØªØµÙˆÛŒØ± Ø³ÙˆØ±Ø³ Ø­Ø¯ÙˆØ¯Ø§Ù‹ Ù…Ø±Ø¨Ø¹ÛŒ Ø§Ø³Øª. Ú©Ø§Ø¯Ø± Ø¢Ø¨ÛŒ Ø¯Ø± Ù†ÛŒÙ…Ù‡ Ù¾Ø§ÛŒÛŒÙ†ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.
        let startY = canvas.height * 0.62; 
        
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø¯ÙˆØ±Ø®Ø· Ù…Ø´Ú©ÛŒ
        function drawTextWithStroke(text, x, y, font, sizeMultiplier, color) {
            // Ù…Ù‚ÛŒØ§Ø³â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§ÛŒØ² ÙÙˆÙ†Øª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø±Ø²ÙˆÙ„ÙˆØ´Ù† ØªØµÙˆÛŒØ±
            let realSize = sizeMultiplier * (canvas.width / 400); 
            ctx.font = `bold ${realSize}px '${font}', 'Vazirmatn', sans-serif`;
            ctx.lineWidth = realSize * 0.15; // Ø¶Ø®Ø§Ù…Øª Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø³Ø§ÛŒØ²
            ctx.strokeStyle = "black";
            ctx.strokeText(text, x, y);
            ctx.fillStyle = color;
            ctx.fillText(text, x, y);
            return realSize;
        }

        // Ø®Ø· Ø§ÙˆÙ„: ØªØ§Ø±ÛŒØ®
        const dateStr = getPersianDateStr();
        drawTextWithStroke(`Ù†Ù…Ø§Ø² Ø¬Ù…Ø¹Ù‡ ${toPersianDigits(dateStr)} Ø¯Ù‡Ø³ØªØ§Ù† Ù…ÛŒØ§Ù†Ú©Ø§Ù„Ù‡ (Ø²Ø§ØºÙ…Ø±Ø²)`, centerX, startY, 'B Nazanin', 10, 'white');

        // Ø®Ø· Ø¯ÙˆÙ…: Ù†Ø§Ù… Ø§Ù…Ø§Ù… Ø¬Ù…Ø¹Ù‡
        startY += canvas.height * 0.06;
        drawTextWithStroke("Ø§Ù…Ø§Ù… Ø¬Ù…Ø¹Ù‡ Ù…Ø­ØªØ±Ù… Ø¯Ù‡Ø³ØªØ§Ù† Ù…ÛŒØ§Ù†Ú©Ø§Ù„Ù‡(Ø²Ø§ØºÙ…Ø±Ø²) Ø­Ø¬Øª Ø§Ù„Ø§Ø³Ù„Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ù„Ù…ÛŒÙ† Ø­Ø§Ø¬ Ø­Ø³ÛŒÙ† Ø§Ù†Ø²Ø§Ø¦ÛŒ:", centerX, startY, 'B Nazanin', 13, 'white');

        // Ø®Ø· Ø³ÙˆÙ…: Ù…ØªÙ† Ù†Ù‚Ù„ Ù‚ÙˆÙ„ (Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø´Ú©Ø³ØªÙ† Ø®Ø·ÙˆØ· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ)
        startY += canvas.height * 0.08;
        wrapText(ctx, `Â«${quoteText}Â»`, centerX, startY, canvas.width * 0.85, 'B Titr', 15.5, 'yellow', canvas.width);

        return canvas.toDataURL("image/jpeg", 0.95);
    }

    // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø´Ú©Ø³ØªÙ† Ø®Ø·ÙˆØ· Ø¨Ø±Ø§ÛŒ Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¯Ø§Ø®Ù„ Ú©Ø§Ø¯Ø±
    function wrapText(ctx, text, x, y, maxWidth, font, sizeMultiplier, color, canvasWidth) {
        let realSize = sizeMultiplier * (canvasWidth / 400);
        ctx.font = `bold ${realSize}px '${font}', 'Vazirmatn', sans-serif`;
        const words = text.split(' ');
        let line = '';
        let currentY = y;
        const lineHeight = realSize * 1.5;
        ctx.lineWidth = realSize * 0.15;

        for (let n = 0; n < words.length; n++) {
            let testLine = line + words[n] + ' ';
            let metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) {
                ctx.strokeStyle = "black"; ctx.strokeText(line, x, currentY);
                ctx.fillStyle = color; ctx.fillText(line, x, currentY);
                line = words[n] + ' ';
                currentY += lineHeight;
            } else {
                line = testLine;
            }
        }
        ctx.strokeStyle = "black"; ctx.strokeText(line, x, currentY);
        ctx.fillStyle = color; ctx.fillText(line, x, currentY);
    }
</script>
</body>
</html>

